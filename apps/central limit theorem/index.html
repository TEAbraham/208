<!DOCTYPE html>
<html>
  <head>
    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
      import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithPopup, GoogleAuthProvider  } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
      import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
      import { firebaseConfig } from '../../js/firebase-config.js';

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Check if user is logged in
      onAuthStateChanged(auth, (user) => {
          if (!user) {
              // User not logged in, save current page before redirecting
              localStorage.setItem("redirectAfterLogin", window.location.href);
              window.location.href = "../../index.html";
          }
      });
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central Limit Theorem</title>

    <!-- CSS Imports -->
    <link rel="stylesheet" type="text/css" href="../../css/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/jquery.fullpage.css" />
    <link rel="stylesheet" href="../../css/home.css">
    <!--Fonts-->
    <link href="//fonts.googleapis.com/css?family=Lato:100,200,300,400" rel="stylesheet" type="text/css">
    <!--Font Awesome-->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!--Favicon-->
    <link rel="shortcut icon" type="image/png" href="../../img/favicon.png" />

    <!-- JavaScript Imports -->
    <!-- Jquery -->
    <script src="../../js/jquery.min.js"></script>
    <script src="../../js/jquery-ui.js"></script>
    <!-- jstat -->
    <script src="../../js/jStat.js"></script>
    <!-- LaTeXMathML -->
    <script src="../../js/LaTeXMathML.js"></script>
    <!-- D3 -->
    <script src="../../js/d3.v7.min.js"></script>
    <!-- Module scripts -->
    <script type="module" src="../../js/script.js"></script>
    <script type="module" src="../../js/home.js"></script>
    <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>

svg {
  width: 100%;
  height: 100%;
  display: block;
}

.Row {
    display: table;
    width: 100%;
    table-layout: fixed;
    border-spacing: 10px;
  }
.Column {
    display: flex;
    flex-direction: column;
}
  
.visualization-wrapper {
  width: 100%;
  height: 100%;
  flex: 1;
  position: relative;
}

.left {
  width: 35%;
}

.right {
  width: 65%;
}
.header {

    background-color: #FFF2E8;
    background: -webkit-linear-gradient(rgba(255,242,232, 1), rgba(255,242,232, 1), rgba(255,242,232, 0));
    /* For Safari 5.1 to 6.0 */
    background: -o-linear-gradient(rgba(255,242,232, 1), rgba(255,242,232, 1), rgba(255,242,232, 0));
    /* For Opera 11.1 to 12.0 */
    background: -moz-linear-gradient(rgba(255,242,232, 1), rgba(255,242,232, 1), rgba(255,242,232, 0));
    /* For Firefox 3.6 to 15 */
    background: linear-gradient(rgba(255,242,232, 1), rgba(255,242,232, 1), rgba(255,242,232, 0));
    /* Standard syntax */
}

.interactive-wrapper {
    display: block;
    width: auto;
    margin: 0 auto;
    text-align: center;
  }

.action-buttons ul a li:hover {
    color: #FF9B41;
}


.action-buttons ul {
    border-top: 1px solid rgba(255,155,65, 0.2);
}

.button-1 {
    border: 1px solid #D0D0D0;
    display: inline-block;
    padding: 0.6em 1em;
    margin: 2% 1%;
    color: black;
    background-color: white;
    pointer-events: auto;
    -webkit-transition: background-color 0.5s ease-out;
    -webkit-transition: border 0.2s ease-out;
    border-radius: 6px;
}

.button-1.sample_btn.active,.button-1.sample_btn:hover{
    border: 1px solid #FF8B22;
    background-color: #FF8B22;
    color:white;
}
.action-buttons ul {

  border-top: 1px solid rgba(245,216,0, 0.8);
}

input[type=range].blueSlider::-webkit-slider-thumb {

/* border: 0.5px solid #F5D800;*/
background: #F5D800;
/* box-shadow: 0px 0px 5px #F5D800;*/

}

input[type=range].greenSlider::-webkit-slider-thumb {

/* border: 0.5px solid #F5D800;*/
background: #FF8B22;
/* box-shadow: 0px 0px 5px #F5D800;*/

}

/*Discrete and Continuous*/

svg g image {
  opacity: 0.5;
  cursor: pointer;
}


svg g image:hover {
  opacity: 1;
}

#descriptionTable td {
  vertical-align: middle;
}

#parameters {
  display: block;
  align-items: center;
  text-align: left;
  margin: 0 auto;

}
label {
  padding-right: 10px;
  font-weight: normal; 
}
.slider.slider-horizontal {
  width: 140px;
  margin-right: 10px;
}

#cltGraph{
	height: 500px;
}

.axis path,
.axis line {
	fill: none;
	stroke: black;
	stroke-width: 1;
	shape-rendering: crispEdges;
}

.axis text {
	font-family: "Helvetica Neue";
	font-size: 11px;
	fill: black;
}

.distribution{
	display: none;
}

#shift{
	cursor: move;
}

#pdf {
	fill: none;
	stroke:	#F5D800;
  stroke-width: 5;
}
#cdf {
	fill: none;
	stroke:	#FF8B22;
  stroke-width: 5;
}

#pdfArea {
	fill: #F5D800;
	opacity: 0.5;
}

.ticks {
  display: none;
}
.handle {
  fill: #FF8B22;
}


/*Central Limit Theorem*/

circle {
  fill: #F5D800;
}

.bar rect {
  fill: #FF8B22;
  fill-opacity: 0.5;
}

.bar text {
  fill: black;
}


.normal {
	fill: #FF8B22;
}

#dt {
  width: 150px;
}
.d3-tip {
    line-height: 1;
    font-weight: bold;
    padding: 6px;
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    border-radius: 2px;
    pointer-events: none;
    font-size: 0.9em;
  }

</style>
</head>
    <body>
        <header class="menu-top">
            <ul id="menu">
                <li class="dropdown">
                    <a href="../../home/home.html" class="dropbtn">Home</a>
                    <ul class="dropdown-content">
                        <li><a href="../../home/home.html#unit1">Unit 1</a></li>
                        <li><a href="../../home/home.html#unit2">Unit 2</a></li>
                        <li><a href="../../home/home.html#unit3">Unit 3</a></li>
                        <li><a href="../../home/home.html#unit4">Unit 4</a></li>
                        <li><a href="../../home/home.html#unit5">Unit 5</a></li>
                        <li><a href="../../home/home.html#unit6">Unit 6</a></li>
                        <li><a href="../../home/home.html#unit7">Unit 7</a></li>
                        <li><a href="../../home/home.html#unit8">Unit 8</a></li>
                        <li><a href="../../home/home.html#unit9">Unit 9</a></li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="https://classroom.google.com/u/1/" class="dropbtn" target="_blank">Classroom</a>
                    <ul class="dropdown-content">
                        <li><a href="https://classroom.google.com/u/1/c/NzA4OTk2OTI3MzAw" target="_blank">Announcements</a></li>
                        <li><a href="https://classroom.google.com/u/1/w/NzA4OTk2OTI3MzAw/t/all" target="_blank">Course Documents</a></li>
                    </ul>
                </li>
                <li class="dropdown">
                  <a href="../../apps" class="dropbtn">Apps</a>
                  <ul class="dropdown-content">
                    <li><a href="../../apps/conditional_probability/">Conditional Probability</a></li>
                    <li><a href="../../apps/galton_board/">Galton Board</a></li>
                    <li><a href="../../apps/normal_distribution/">Normal Distribution</a></li>
                    <li><a href="../../apps/binomial_distribution/">Binomial Distribution</a></li>
                    <li><a href="../../apps/geometric_distribution/">Geometric Distribution</a></li>
                    <li><a href="../../apps/random_variables/">Random Variables</a></li>
                    <li><a href="../../apps/sampling_distributions/">Confidence Intervals</a></li>
                  </ul>
                </li>
                <li class="dropdown">
                  <a href="../../mcq/" class="dropbtn">MCQ</a>
                </li>
                <li class="dropdown">
                  <a href="../../frq/" class="dropbtn">FRQ</a>
              </li>
              <li class="dropdown">
                  <a href="../../collegeboard/" class="dropbtn">CollegeBoard</a>
              </li>
              <li class="dropdown">
                  <a href="../../prep/" class="dropbtn">Exam Prep</a>
              </li>
                <li id="logoutButton" style="display:none;"><a href="../../index.html" onclick="logout('../../index.html')">Logout</a></li>
            </ul>
            <div id="logo"></div>
        </header>
<!-- Discrete and Continuous Section -->
<div id="section2" class="Row">
  <div class="Column left">
    <h3>Discrete and Continuous</h3>
    <p>There are two major classes of probability distributions.</p>
  
    <div class="interactive-wrapper slider-align">
      <label class="radio-inline">Discrete
        <input type="radio" name="distributions" value="discrete" checked>
        <span class="checkmark"></span>
      </label>
      <label class="radio-inline">Continuous
        <input type="radio" name="distributions" value="continuous">
        <span class="checkmark"></span>
      </label>
    </div>
  
    <!-- Discrete description and dropdown -->
    <div class="definition">
      <p>A discrete random variable has a finite or countable number of possible values.</p>
      <p>If $ X $ is a discrete random variable, then:</p>
      $P(X = x) = f(x) $ <br> $ P(X < x) = F(x)$
      <p>Choose a distribution to visualize:</p>
      <div class="interactive-wrapper">
        <select id="discreteSelect" class="distributions st-dropdown">

          <option value="bernoulli" selected>Bernoulli</option>
          <option value="binomialDiscrete">Binomial</option>
          <option value="geometric">Geometric</option>
          <option value="poisson">Poisson</option>
          <option value="negbin">Negative Binomial</option>
        </select>
      </div>
    </div>
<!-- Central Limit Theorem Section -->
<div id="section3" class="Row">
  <div class="Column left">
    <h3>Central Limit Theorem</h3>
    <p>The CLT states the sample mean of many i.i.d. variables is approximately normal. Larger samples improve approximation.</p>

    <div class="interactive-wrapper">
      <label for="alpha_clt">
        $ \alpha$ = <span id="alpha_clt-value">1.00</span>
      </label>
      <input id="alpha_clt" class="inputDist blueSlider" type="range" min="0.1" max="5" step="0.01" value="1.00">
      <br>
      <label for="beta_clt">
        $ \beta$ = <span id="beta_clt-value">1.00</span>
      </label>
      <input id="beta_clt" class="inputDist blueSlider" type="range" min="0.1" max="5" step="0.01" value="1.00">
    </div>

    <p>Set sample size and draw count, then click "Sample." Optionally show the theoretical distribution.</p>
    <div class="interactive-wrapper">
      <label for="sample">
        Sample size = <span id="sample-value">1</span>
      </label>
      <input id="sample" class="inputDist greenSlider" type="range" min="1" max="15" step="1" value="1">
      <br>
      <label for="draws">
        Draws = <span id="draws-value">1</span>
      </label>
      <input id="draws" class="inputDist greenSlider" type="range" min="1" max="50" step="1" value="1">
      <br>
      <label class="form-check">Theoretical
        <input class="form-check-input" id="theoretical" type="checkbox">
        <span class="checkbox-mark"></span>
      </label>
      <div class="button-1" id="sample">Sample</div>
    </div>
  </div>
  <div class="Column right">
    <div class="visualization-wrapper">
      <svg id="cltGraph"></svg>
    </div>
  </div>
</div>
<script>
//Handles functionality of Distributions
$(function () {
  discrete_continuous();
  clt();
});


// Extend D3 selection prototype for bringing elements to front/back
d3.selection.prototype.moveToFront = function() {
  return this.each(function() {
      this.parentNode.appendChild(this);
  });
};

d3.selection.prototype.moveToBack = function() {
  return this.each(function() {
      this.parentNode.insertBefore(this, this.parentNode.firstChild);
  });
};

// Additional jStat functions
jStat.bernoulli = {
  pdf: (k, p) => (k < 0 || !Number.isInteger(k) || k > 1 || p < 0 || p > 1) ? 0 : jStat.binomial.pdf(k, 1, p),
  cdf: (k, p) => jStat.binomial.cdf(k, 1, p),
  mean: (p) => p,
  sample: (p) => Array.from({length: 1}, () => +(Math.random() < p)).reduce((a, b) => a + b, 0)
};

jStat.geometric = {
  pdf: (k, p) => (k < 1 || !Number.isInteger(k) || p < 0 || p > 1) ? 0 : (1-p)**(k-1)*p,
  cdf: (k, p) => { let sum = 0; for (let i = 1; i <= k; i++) {sum +=jStat.geometric.pdf(i,p) }; return sum  },
  mean: (p) => 1/p,
  sample: (p) => Array.from({length: 1}, () => +(Math.random() < p)).reduce((a, b) => a + b, 0)
};


//Additional Functions to JSTAT
jStat.binomialDiscrete = {};

jStat.binomialDiscrete.pdf = function(k, n, p) {
  if (k < 0 || !Number.isInteger(k) || k > n || p < 0 || p > 1) {
      return 0;
  } else {
      return jStat.binomial.pdf(k, n, p);
  }
}

jStat.binomialDiscrete.cdf = function(k, n, p) {
  return jStat.binomial.cdf(k, n, p);
}

jStat.binomialDiscrete.mean = function(n, p) {
  return n * p;
}

jStat.binomialDiscrete.sample = function(n, p) {
  var sum = 0;
  for (var i = 0; i < n; i++) {
      sum += +(Math.random() < p);
  }
  return sum;
}

jStat.bernoulli = {};

jStat.bernoulli.pdf = function(k, p) {
  return jStat.binomialDiscrete.pdf(k, 1, p);
}

jStat.bernoulli.cdf = function(k, p) {
  return jStat.binomial.cdf(k, 1, p);
}

jStat.bernoulli.mean = function(p) {
  return p;
}

jStat.bernoulli.sample = function(p) {
  return +(Math.random() < p);
}

jStat.negbin.mean = function(r, p) {
  return (1 - p) * r / p;
}

jStat.poisson.mean = function(lambda) {
  return lambda;
}

// D3 setup for distGraph
const xScaleDist = d3.scaleLinear().range([0, 400]);
const yScaleDist = d3.scaleLinear().range([300, 0]);

const xAxisDist = d3.axisBottom(xScaleDist);
const yAxisDist = d3.axisLeft(yScaleDist);

const svgDist = d3.select("#distGraph")
  .attr("viewBox", "0 0 500 350")
  .attr("preserveAspectRatio", "xMidYMid meet");

const xDist = svgDist.append("g")
  .attr("transform", "translate(50, 300)");

const yDist = svgDist.append("g")
  .attr("transform", "translate(50, 0)");

const graphGroup = svgDist.append("g")
  .attr("transform", "translate(50, 0)");

const pdfPath = graphGroup.append("path")
  .attr("class", "pdf-line")
  .attr("fill", "none")
  .attr("stroke", "steelblue")
  .attr("stroke-width", 2);

const pdfArea = graphGroup.append("path")
  .attr("class", "pdf-area")
  .attr("fill", "lightblue")
  .attr("opacity", 0.5);

const cdfPath = graphGroup.append("path")
  .attr("class", "cdf-line")
  .attr("fill", "none")
  .attr("stroke", "green")
  .attr("stroke-width", 2);

function reset_slider() {
  $("#percentDist").val(0);
  currentPercent = 0;
}
  
const parameters = {
  bernoulli: ['Probability'],
  binomialDiscrete: ['Number', 'Probability'],
  negbin: ['Number', 'Probability'],
  geometric: ['Probability'],
  poisson: ['Lambda'],
  uniform: ['Min', 'Max'],
  normal: ['Mean', 'Std'],
  studentt: ['Dof'],
  chisquare: ['Dof'],
  exponential: ['Lambda'],
  centralF: ['Dof1', 'Dof2'],
  gamma: ['Shape', 'Scale'],
  beta: ['Alpha', 'Beta']
};

const initialParameters = {
  bernoulli: [0.5],
  binomialDiscrete: [5, 0.5],
  negbin: [5, 0.5],
  geometric: [0.5],
  poisson: [5],
  uniform: [-5, 5],
  normal: [0, 1],
  studentt: [5],
  chisquare: [5],
  exponential: [1],
  centralF: [5, 5],
  gamma: [1, 1],
  beta: [1, 1]
};

const parameterRanges = {
  Probability: [0.01, 1, 0.01],
  Number: [1, 50, 1],
  Lambda: [0.01, 10, 0.01],
  Min: [-10, 0, 0.1],
  Max: [0, 10, 0.1],
  Mean: [-10, 10, 0.1],
  Std: [0.01, 10, 0.01],
  Dof: [1, 30, 1],
  Dof1: [1, 30, 1],
  Dof2: [1, 30, 1],
  Shape: [0.1, 10, 0.1],
  Scale: [0.1, 10, 0.1],
  Alpha: [0.1, 10, 0.1],
  Beta: [0.1, 10, 0.1]
};

const initialView = {
  bernoulli: [-1, 5],
  binomialDiscrete: [-1, 5],
  negbin: [-1, 5],
  geometric: [-1, 5],
  poisson: [-1, 5],
  uniform: [-6, 6],
  normal: [-5, 5],
  studentt: [-5, 5],
  chisquare: [-1, 8],
  exponential: [-1, 5],
  centralF: [-1, 5],
  gamma: [-1, 5],
  beta: [-0.5, 1.5]
};

let currentDist = "bernoulli";
let currentView = [-5, 5];
let currentPercent = 0;

const zoom = d3.zoom().scaleExtent([0.25, 4]).on("zoom", () => {});

function updateRangeInput(n, id) {
  const value = parseFloat(n);
  if (!isNaN(value)) {
    document.getElementById(id + "-value").textContent = value.toFixed(2);
  }
}

function redrawPath(dist) {
  if (!dist || !parameters[dist]) return;
  const paramKeys = parameters[dist];
  for (const key of paramKeys) {
    if (!document.getElementById(dist + key)) return;
  }

  const line = d3.line()
    .x(d => xScaleDist(d[0]))
    .y(d => yScaleDist(d[1]))
    .curve(d3.curveLinear);

  const area = d3.area()
    .x(d => xScaleDist(d[0]))
    .y0(yScaleDist(0))
    .y1(d => yScaleDist(d[1]))
    .curve(d3.curveLinear);

  const paramValues = paramKeys.map(k => parseFloat(document.getElementById(dist + k).value));
  paramValues.unshift(0);

  pdfPath
    .datum(d3.range(Math.floor(currentView[0]), Math.ceil(currentView[1]) + 0.01, 0.01).map(x => {
      paramValues[0] = x;
      return [x, Math.min(jStat[dist].pdf.apply(null, paramValues), 5)];
    }))
    .attr("d", line);

  pdfArea
    .datum(d3.range(currentView[0], currentView[0] + (currentView[1] - currentView[0]) * currentPercent + 0.01, 0.01).map(x => {
      paramValues[0] = x;
      return [x, Math.min(jStat[dist].pdf.apply(null, paramValues), 5)];
    }))
    .attr("d", area);

  cdfPath
    .datum(d3.range(currentView[0], currentView[0] + (currentView[1] - currentView[0]) * currentPercent + 0.01, 0.01).map(x => {
      paramValues[0] = x;
      return [x, jStat[dist].cdf.apply(null, paramValues)];
    }))
    .attr("d", line);
}

function discrete_continuous() {
  $("input[name='distributions']").on("change", function () {
    const value = $(this).val();
    if (value === "discrete") {
      $("#discreteSelect").parent().parent().show();
      $("#continuousSelect").parent().parent().hide();
    } else {
      $("#discreteSelect").parent().parent().hide();
      $("#continuousSelect").parent().parent().show();
    }
    $('#parameterSliders').hide().empty();
    $('#resetDist').hide();
    $("#descriptionTable .distribution").hide();
    $(".distribution").hide();
    currentDist = $('.distributions').val();
    redrawPath(currentDist);
    $('.distributions').trigger('change');
  });

  $('.distributions').on('change', function () {
    const dist = $(this).val();
    if (!parameters[dist]) return; // invalid or placeholder selection

    currentDist = dist;
    $('#parameterSliders').empty().show();
    $('#descriptionTable').show();

    // Hide all rows
    $("#descriptionTable .distribution").hide();
    $(".distribution").hide();
    // Show only the matching distribution
    $("#descriptionTable ." + dist).show();
    $("." + dist).show();

    $('#resetDist').show();

    const paramNames = parameters[dist];
    const paramValues = initialParameters[dist];

    paramNames.forEach((param, i) => {
      const id = dist + param;
      const value = paramValues[i];
      const [min, max, step] = parameterRanges[param] || [0.01, 10, 0.01];

      const inputHTML = `
        <div style="margin: 10px 0;">
          <label for="${id}">${param} = <span id="${id}-value">${value}</span></label><br>
          <input
            type="range"
            min="${min}"
            max="${max}"
            step="${step}"
            value="${value}"
            id="${id}"
            class="inputDist"
          >
        </div>
      `;
      $('#parameterSliders').append(inputHTML);
    });

    $(".inputDist").on("input", function () {
      const id = this.id;
      const value = parseFloat(this.value);
      if (!isNaN(value)) {
        $("#" + id + "-value").text(value.toFixed(2));
        redrawPath(currentDist);
      }
    });

    currentView = initialView[dist] || [-5, 5];
    xScaleDist.domain(currentView);
    yScaleDist.domain([0, 1]);
    xDist.call(xAxisDist);
    yDist.call(yAxisDist);
    currentPercent = 0;
    reset_slider();
    redrawPath(dist);
  });

  $('#resetDist').on('click', function () {
    $(".distributions:visible").trigger("change");
  });
}

$(function () {
  discrete_continuous();
  $(".distributions:visible").trigger("change");
});

//*******************************************************************************//
//Central Limit Theorem
//*******************************************************************************//

function clt() {
  // define width, height, margin
  var margin = {top: 15, right: 5, bottom: 15, left: 5};
  var width = 800;//parseInt(d3.select("#cltGraph").style("width")) - margin.left - margin.right,
      height = 500;
  // create svg
  var svg_clt = d3.select("#cltGraph").append("svg")
    .attr("width", "100%")
    .attr("height", "100%")
    .attr("viewBox", "0 0 " + (width + margin.left + margin.right) + " " + (height + margin.top + margin.bottom))
    .attr("preserveAspectRatio", "xMidYMid meet")
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // constants
  var dt = 100,
      n = 1,
      draws = 1,
      alpha = 1,
      beta = 1,
      y1 = height / 3,
      y2 = height / 4,
      bins = 20,
      counts = [],
      interval_clt;


  // scales
  var x_scale_clt = d3.scaleLinear().domain([0, 1]).range([0, width]);
  var y_scale_clt = d3.scaleLinear().domain([0, 3]).range([0, height - (2*y1)]);
  var z_scale_clt = d3.scaleLinear().domain([0, 3]).range([0, y1]);


  // clip path
  var clip_clt = svg_clt.append("clipPath")
                  .attr("id", "view_clt")
                  .append("rect")
                  .attr("x", 0)
                  .attr("y", height - (2*y1 - y2))
                  .attr("width", width)
                  .attr("height", (2*y1 - y2));

  // draw horizontal bar
  function draw_bar(selection, dy, label) {
    // group
    var axis = selection.append("g").attr("class", "axis");
    // bar
    axis.append("line")
      .attr("x1", x_scale_clt(0))
      .attr("x2", x_scale_clt(1))
      .attr("y1", dy)
      .attr("y2", dy);
    // label
    axis.append("text")
      .attr("x", x_scale_clt(0))
      .attr("y", dy)
      .attr("dy", "1em")
      .text(label);
  };
  // create three bars
  svg_clt.call(draw_bar, y1, "draw");
  svg_clt.call(draw_bar, y1+y2, "average");
  svg_clt.call(draw_bar, 3*y1, "count");


  // path and area elements
  var sampling_path = svg_clt.append("path").attr("id", "pdf"),
      sampling_area = svg_clt.append("path").attr("id", "pdfArea"),
      theoretical_path = svg_clt.append("path")
                                .attr("id", "cdf")
                                .attr("opacity", 0)
                                .attr("clip-path", "url(#view_clt)")
                                .moveToBack();

  // Update sampling distributions
  function draw_sampling() {
    // path function
    const line = d3.line()
    .x(d => x_scale_clt(d[0]))
    .y(d => y_scale_clt(d[1]))
    .curve(d3.curveLinear);
    const area = d3.area()
      .x(d => x_scale_clt(d[0]))
      .y0(y_scale_clt(0))
      .y1(d => y_scale_clt(d[1]))
      .curve(d3.curveLinear);
    // pdf data
    var datum = d3.range(0, 1.05, 0.05).map(function(x) { 
      return [x, Math.min(jStat.beta.pdf(x, alpha, beta),10)]; 
    })
    // update sampling distribution
  	sampling_path.datum(datum).attr("d", line);
  	sampling_area.datum(datum).attr("d", area);
    // draw threoretical
    draw_theoretical(datum);
  }

  // draw theoretical distribution
  function draw_theoretical(datum) {
    // path function
    const line = d3.line()
      .x(d => x_scale_clt(d[0]))
      .y(d => y_scale_clt(d[1]))
      .curve(d3.curveLinear);
    // update theoretical distribution
    if (n == 1) {
      theoretical_path.datum(datum).attr("d", line);
      //y_scale_clt.domain([0,3]);
    } else {
      var mean = jStat.beta.mean(alpha, beta);
      var variance = jStat.beta.variance(alpha, beta)/n;
      var x_mode = jStat.normal.mode(mean, Math.sqrt(variance));
      y_scale_clt.domain([0, jStat.normal.pdf(x_mode, mean, Math.pow(variance,0.5))]);
      datum = d3.range(0, 1.05, 0.01).map(function(x) { return [x, jStat.normal.pdf(x, mean, Math.pow(variance,0.5))]; });
      theoretical_path.datum(datum).attr("d", line);
    }
  }

  // create histogram
  const histogram = d3.bin()
    .domain(x_scale_clt.domain())
    .thresholds(x_scale_clt.ticks(bins));  
  var bars = svg_clt.append("g").attr("class", "histogram");

  function draw_histogram() {
    // get histrogram of counts
    var data = histogram(counts);
    // update scale
    var ymax = d3.max(data.map(function(d) { return d.y; }));
    y_scale_clt.domain([0, ymax*bins]);
    // enter bars
    var bar = bars.selectAll("g").data(data);
    var barEnter = bar.enter().append("g").attr("class", "bar");
    barEnter.append("rect");
    barEnter.append("text")
      .attr("y", 3*y1 - 15)
      .attr("text-anchor", "middle");
    // update bars
    bar.select("rect")
      .attr("x", function(d) { return x_scale_clt(d.x) + 1; })
      .attr("width", x_scale_clt(data[0].dx) - 1)
    .transition().duration(250)
      .attr("y", function(d) { return 3*y1 - y_scale_clt(d.y*bins); })
      .attr("height", function(d) { return y_scale_clt(d.y*bins); });
    bar.select("text")
      .attr("x", function(d) { return x_scale_clt(d.x + 1/(2*bins)); })
      .text(function(d) { return d.y > 0 ? d3.format("%")(d.y) : ""; });
    // exit bars
    bar.exit().remove();
  };

  // Creates Circles and transitions
  function tick() {
    // take samples
    var data = [];
    for (var i = 0; i < n; i++) {
      data.push(jStat.beta.sample(alpha,beta));
    };
    var mean = d3.mean(data);
    // add balls
    var group = svg_clt.append("g").attr("class", "ball-group");
    var balls = group.selectAll(".ball").data(data);
    // animate balls
    var i = 0, j = 0;
    balls.enter()
      .append("circle")
      .attr("class", "ball")
      .attr("cx", function(d) { return x_scale_clt(d); })
      .attr("cy", y1)
      .attr("r", 5)
      .transition()
      .duration(dt)
      .attr("cy", y1 + y2 - 5)
      .each(function() { ++i; })
      .each("end", function() {
        if (!--i) {
          balls
            .transition()
            .duration(400)
            .attr("cx", x_scale_clt(mean))
            .style("fill", "#FF8B22")
            .transition()
            .duration(400)
            .attr("cy", 3*y1-3)
            .attr("r", 3)
            .each(function() { ++j; })
            .each("end", function() {
              if (!--j) {
                counts.push(mean);
                draw_histogram();
                draw_sampling();
              }
              d3.select(this).remove();
            });
        };
      });
  }

  // initiate sampling
  function start_sampling() {
    dt = 350/Math.pow(1.04, draws);
    var count = 0;
    interval_clt = setInterval(function() { 
      tick();
        if (++count === draws){
          clearInterval(interval_clt);
        }
    }, dt);
  }


  function reset_clt() {
    clearInterval(interval_clt);
    counts = [];
  
    // Remove all SVG elements as before
    svg_clt.selectAll("circle").remove();
    svg_clt.selectAll(".bar").remove();
  
    // Reset the y-scale domain and redraw
    y_scale_clt.domain([0, 3]);
    draw_sampling();
  }
  

  // update alpha
  $("#alpha_clt").on("input", function(e) {
    alpha = parseFloat($(this).val());
    d3.select("#alpha_clt-value").text(alpha);
    reset_clt();
  });

  // update beta
  $("#beta_clt").on("input", function(e) {
    beta = parseFloat($(this).val());
    d3.select("#beta_clt-value").text(beta);
    reset_clt();
  });

  // update sample size
  d3.select("#sample").on("input", function() {
    n = +this.value;
    d3.select("#sample-value").text(n);
    reset_clt();
  	});

  // update number of draws
  d3.select("#draws").on("input", function() {
    draws = +this.value;
    d3.select("#draws-value").text(draws);
  });

  // theoretical on/off
  $("#theoretical").change(function() {
     if($(this).is(":checked")) {
        theoretical_path.attr("opacity", 1);
     } else {
        theoretical_path.attr("opacity", 0);
     }
     draw_sampling();
  });

  // drop balls
  $("#form_clt").click(function() {
    clearInterval(interval_clt);
    start_sampling();
  });

  draw_sampling();
};
</script>

  </body>
</html>